# syntax=docker/dockerfile:1.4

# Build stage (same as above)
FROM eclipse-temurin:21-jdk-alpine AS build
RUN apk add --no-cache bash
WORKDIR /app
COPY .mvn .mvn
COPY mvnw .
COPY pom.xml .
RUN chmod +x mvnw
RUN --mount=type=cache,target=/root/.m2 \
    ./mvnw dependency:go-offline -B
COPY src ./src
RUN --mount=type=cache,target=/root/.m2 \
    ./mvnw clean package -DskipTests && \
    java -Djarmode=layertools -jar target/*.jar extract --destination target/extracted

# Production stage - Distroless (no shell, minimal attack surface)
FROM gcr.io/distroless/java21-debian12:nonroot

WORKDIR /app

# Copy layers
COPY --from=build --chown=nonroot:nonroot /app/target/extracted/dependencies/ ./
COPY --from=build --chown=nonroot:nonroot /app/target/extracted/spring-boot-loader/ ./
COPY --from=build --chown=nonroot:nonroot /app/target/extracted/snapshot-dependencies/ ./
COPY --from=build --chown=nonroot:nonroot /app/target/extracted/application/ ./

EXPOSE 8080
USER nonroot

# Note: Distroless doesn't support HEALTHCHECK with wget, handle health checks externally
ENTRYPOINT ["java", \
    "-XX:+UseContainerSupport", \
    "-XX:MaxRAMPercentage=75.0", \
    "org.springframework.boot.loader.launch.JarLauncher"]