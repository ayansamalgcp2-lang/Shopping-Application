# syntax=docker/dockerfile:1.4

FROM eclipse-temurin:21-jdk-alpine AS base
RUN apk add --no-cache bash
WORKDIR /app

# Layer 1: Maven wrapper (almost never changes)
FROM base AS mvn-setup
COPY .mvn .mvn
COPY mvnw .
RUN chmod +x mvnw

# Layer 2: Dependencies (changes only when pom.xml changes)
FROM mvn-setup AS dependencies
COPY pom.xml .
COPY settings.xml /root/.m2/settings.xml
RUN --mount=type=cache,target=/root/.m2,id=maven-cache \
    ./mvnw dependency:go-offline -B -T 4

# Layer 3: Build (changes when code changes)
FROM dependencies AS build
COPY src ./src
RUN --mount=type=cache,target=/root/.m2,id=maven-cache \
    ./mvnw package -DskipTests -T 4 -o && \
    java -Djarmode=layertools -jar target/*.jar extract --destination target/extracted

# Production
FROM gcr.io/distroless/java21-debian12:debug-nonroot
WORKDIR /app
COPY --from=build --chown=nonroot:nonroot /app/target/extracted/dependencies/ ./
COPY --from=build --chown=nonroot:nonroot /app/target/extracted/spring-boot-loader/ ./
COPY --from=build --chown=nonroot:nonroot /app/target/extracted/snapshot-dependencies/ ./
COPY --from=build --chown=nonroot:nonroot /app/target/extracted/application/ ./
EXPOSE 8080
USER nonroot
ENTRYPOINT ["java", "-XX:+UseContainerSupport", "-XX:MaxRAMPercentage=75.0", \
    "org.springframework.boot.loader.launch.JarLauncher"]